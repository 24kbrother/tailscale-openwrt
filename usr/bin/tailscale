#!/bin/sh
set -e
if [ ! -f /tmp/tailscale ]; then
    arch=`uname -m`
    if [ "$arch" == "i386" ]; then
        arch=386
    elif [ "$arch" == "x86_64" ]; then
        arch=amd64
    elif [ "$arch" == "armv7l" ]; then
        arch=arm
    elif [ "$arch" == "aarch64" ]; then
        arch=arm64
    elif [ "$arch" == "armv8l" ]; then
        arch=arm64
    elif [ "$arch" == "geode" ]; then
        arch=geode
    elif [ "$arch" == "mips" ]; then
        endianness=`echo -n I | hexdump -o | awk '{ print (substr($2,6,1)=="1") ? "le" : ""; exit }'`
    elif [ "$arch" == "riscv64" ]; then
        arch=riscv64
    else
        echo "当前机器的架构是${arch}${endianness}, 脚本不兼容此输出, 请给作者提issue以便作者及时修改脚本: https://github.com/CH3NGYZ/tailscale-openwrt/issues"
        exit 1
    fi
    tailscale_version="1.54.0"
    release_url="https://github.com/CH3NGYZ/tailscale-openwrt/releases/latest"
    release_urls=(
    "https://git.xfj0.cn/$release_url"
    "https://dl.ghpig.top/$release_url"
    "https://gh.ddlc.top/$release_url"
    "https://gh.h233.eu.org/$release_url"
    "https://slink.ltd/$release_url"
    )

    max_attempts=3
    attempt=1
    latest_version=""

    while [ $attempt -le $max_attempts ]; do
        echo "尝试获取最新版本号，尝试次数: $attempt"
        
        # 获取最新版本号
        for url in "${release_urls[@]}"; do
            latest_version=$(wget --tries=5 -c -t 60 -O- "$url" | grep 已从上游同步 | head -1 | cut -d'%' -f 2)
            echo "网址: $url  结果: $latest_version"
            if [ "$latest_version" != "" ]; then
                echo "获取成功，版本号：$latest_version"
                break  # 如果成功获取到版本号，跳出循环
            fi
        done

        attempt=$((attempt + 1))
    done

    # 如果最终还是无法获取到最新版本号，使用默认版本号
    if [ "$latest_version" == "" ]; then
        latest_version="1.54.0"
        echo "获取失败，使用内置版本号：$latest_version"
    fi

    if [ "$tailscale_version" != "$latest_version" ]; then
        tailscale_version=$latest_version
    fi

    version="${tailscale_version}_${arch}${endianness}"
    echo "正在下载Tailscale_${version} ..."
    echo -e "tailscale_${version}/tailscale" > /tmp/tailscale_${version}_files.txt
    echo -e "tailscale_${version}/tailscaled" >> /tmp/tailscale_${version}_files.txt
    wget --tries=5 -c -t 60 -O- https://cors.isteed.cc/github.com/CH3NGYZ/tailscale-openwrt/releases/download/${tailscale_version}/tailscale_${version}.tgz | tar x -zvf - -C /tmp -T /tmp/tailscale_${version}_files.txt
    mv /tmp/tailscale_$version/* /tmp
    rm -rf /tmp/tailscale_${version}*
    echo "下载完毕!"
fi

/tmp/tailscale "$@"
